<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECR RAILWAY - ANALYSIS PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --danger: #dc2626; --bg: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: var(--primary); }
        header { background: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 800; font-size: 1.4rem; color: var(--accent); }
        .container { max-width: 1450px; margin: 30px auto; padding: 0 20px; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eef2f6; }
        .card h3 { font-size: 0.8rem; text-transform: uppercase; color: #64748b; margin: 0 0 10px 0; letter-spacing: 1px; }
        .card .count { font-size: 2.5rem; font-weight: 800; display: block; margin-bottom: 10px; color: var(--primary); }
        .graph-area { height: 140px; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; font-size: 0.75rem; cursor: pointer; transition: 0.3s; }
        .btn-details { background: #f1f5f9; color: #475569; }
        .btn-vio { background: #fee2e2; color: #dc2626; }
        .btn:hover { filter: brightness(0.9); transform: translateY(-2px); }
        .performer-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 40px; }
        .icon-btn { background: white; padding: 30px; border-radius: 24px; text-align: center; cursor: pointer; border: 2px solid transparent; box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: 0.3s; }
        .icon-btn:hover { border-color: var(--accent); background: #f0f7ff; }
        .icon-btn span { display: block; margin-top: 15px; font-weight: 800; font-size: 0.9rem; }
        .modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-height: 90vh; border-radius: 24px; padding: 35px; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 20px; right: 30px; font-size: 2.5rem; cursor: pointer; color: #94a3b8; }
        .table-wrapper { overflow-x: auto; margin-top: 20px; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; background: white; }
        th { text-align: center; padding: 14px; background: #f8fafc; border: 1px solid #cbd5e1; font-size: 0.75rem; color: #334155; text-transform: uppercase; font-weight: 700; }
        td { padding: 12px; border: 1px solid #cbd5e1; font-size: 0.85rem; color: #0f172a; text-align: center; }
        tr:nth-child(even) { background-color: #f1f5f9; }
        .dl-btn { background: var(--accent); color: white; padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; margin-bottom: 15px; }
    </style>
</head>
<body>

<header>
    <div class="logo">SECR RAIPUR | ANALYSIS DASHBOARD</div>
    <div style="display:flex; gap:20px; align-items:center;">
        <span style="font-weight:700; color:#64748b;">Filter Analysis Date:</span>
        <input type="date" id="globalDate" onchange="refreshDashboard()" style="padding:10px; border-radius:10px; border:2px solid #e2e8f0; font-weight:bold;">
        <button onclick="resetToMonthly()" style="padding:10px 15px; border-radius:10px; border:none; background:var(--primary); color:white; font-weight:bold; cursor:pointer;">Full Month Overview</button>
    </div>
</header>

<div class="container">
    <div class="summary-grid">
        <div class="card">
            <h3>Speedometer / RTIS</h3>
            <span class="count" id="countSPM">0</span>
            <div class="graph-area"><canvas id="chartSPM"></canvas></div>
            <div class="btn-group"><button class="btn btn-details" onclick="openDataWindow('SPM', false)">DETAILS</button><button class="btn btn-vio" onclick="openDataWindow('SPM', true)">VIOLATIONS</button></div>
        </div>
        <div class="card">
            <h3>CVVRS Analysis</h3>
            <span class="count" id="countCV">0</span>
            <div class="graph-area"><canvas id="chartCV"></canvas></div>
            <div class="btn-group"><button class="btn btn-details" onclick="openDataWindow('CVVRS', false)">DETAILS</button><button class="btn btn-vio" onclick="openDataWindow('CVVRS', true)">VIOLATIONS</button></div>
        </div>
        <div class="card">
            <h3>TELOC Cell</h3>
            <span class="count" id="countTL">0</span>
            <div class="graph-area"><canvas id="chartTL"></canvas></div>
            <div class="btn-group"><button class="btn btn-details" onclick="openDataWindow('TELOC', false)">DETAILS</button><button class="btn btn-vio" onclick="openDataWindow('TELOC', true)">VIOLATIONS</button></div>
        </div>
        <div class="card">
            <h3>Bulk Analysis</h3>
            <span class="count" id="countBK">0</span>
            <div class="graph-area"><canvas id="chartBK"></canvas></div>
            <div class="btn-group"><button class="btn btn-details" onclick="openDataWindow('BULK', false)">DETAILS</button><button class="btn btn-vio" onclick="openDataWindow('BULK', true)">VIOLATIONS</button></div>
        </div>
    </div>

    <div class="performer-section">
        <div class="icon-btn" onclick="openMerit('CLI', 'BEST')">ü•á <span>BEST 05 CLI</span></div>
        <div class="icon-btn" onclick="openMerit('LP', 'BEST')">üèÜ <span>BEST 05 LP</span></div>
        <div class="icon-btn" onclick="openMerit('CLI', 'WORST')">‚ö†Ô∏è <span>WORST 05 CLI</span></div>
        <div class="icon-btn" onclick="openMerit('LP', 'WORST')">üî¥ <span>WORST 05 LP</span></div>
    </div>
</div>

<div class="modal" id="dataModal">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('dataModal').style.display='none'">&times;</span>
        <h2 id="modalTitle">Report Window</h2>
        <button id="downloadBtn" class="dl-btn">Download CSV Report</button>
        <div class="table-wrapper" id="tableContainer"></div>
    </div>
</div>

<script>
    const GITHUB_PATH = "https://raw.githubusercontent.com/mlachhwani/cli-teloc-bmy-dashboard/main/data/2026-01";
    let database = { SPM: [], CVVRS: [], TELOC: [], BULK: [], BULK_VIO: [] };
    let charts = {};

    window.onload = async () => {
        await Promise.all([
            fetchCSV('spm.csv', 'SPM'), fetchCSV('cvvrs.csv', 'CVVRS'), fetchCSV('teloc_daily.csv', 'TELOC'),
            fetchCSV('bulk_analysis.csv', 'BULK'), fetchCSV('bulk_violation_details.csv', 'BULK_VIO')
        ]);
        refreshDashboard();
    };

    async function fetchCSV(file, key) {
        try {
            const res = await fetch(`${GITHUB_PATH}/${file}`);
            const text = await res.text();
            const lines = text.split('\n').filter(l => l.trim() !== "");
            database[key] = lines.slice(1).map(row => {
                // Better CSV Parsing for full names with commas or quotes
                const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || row.split(',');
                return cols.map(v => v.trim().replace(/"/g, ''));
            });
        } catch (e) { console.error("Error loading " + file); }
    }

    function resetToMonthly() { document.getElementById('globalDate').value = ""; refreshDashboard(); }

    function refreshDashboard() {
        const selDate = document.getElementById('globalDate').value;
        updateCard('SPM', selDate, 'countSPM', 'chartSPM');
        updateCard('CVVRS', selDate, 'countCV', 'chartCV');
        updateCard('TELOC', selDate, 'countTL', 'chartTL');
        
        const bulkTotal = selDate ? (database.BULK.find(d => d[0] === selDate)?.[1] || 0) : database.BULK.reduce((s, r) => s + (parseInt(r[1]) || 0), 0);
        document.getElementById('countBK').innerText = bulkTotal;
        renderStackedChart('chartBK', database.BULK, true);
    }

    function updateCard(key, date, countId, chartId) {
        const fullData = database[key];
        const displayData = date ? fullData.filter(d => d[2] === date) : fullData;
        document.getElementById(countId).innerText = displayData.length;
        renderStackedChart(chartId, fullData, false);
    }

    function renderStackedChart(canvasId, data, isBulk) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();
        const dates = [...new Set(data.map(d => d[isBulk ? 0 : 2]))].sort();
        const totals = dates.map(d => isBulk ? (parseInt(data.find(r => r[0] === d)?.[1]) || 0) : data.filter(r => r[2] === d).length);
        const vios = dates.map(d => isBulk ? (parseInt(data.find(r => r[0] === d)?.[2]) || 0) : data.filter(r => r[2] === d && r[11] && r[11].toUpperCase() !== 'NIL').length);

        charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates.map(d => d.split('-')[2]),
                datasets: [
                    { label: 'Violations', data: vios, backgroundColor: '#dc2626', barThickness: 6 },
                    { label: 'Safe', data: totals.map((t, i) => t - vios[i]), backgroundColor: '#1e293b', barThickness: 6 }
                ]
            },
            options: { scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, display: false } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }
        });
    }

    function openDataWindow(category, onlyVios) {
        const date = document.getElementById('globalDate').value;
        const modal = document.getElementById('dataModal');
        modal.style.display = 'flex';
        
        let filtered = (category === 'BULK') ? database.BULK_VIO : database[category];
        if (date) filtered = filtered.filter(d => d[category === 'BULK' ? 0 : 2] === date);
        if (onlyVios && category !== 'BULK') filtered = filtered.filter(d => d[11] && d[11].toUpperCase() !== 'NIL');

        document.getElementById('modalTitle').innerText = `${category} - ${onlyVios ? 'VIOLATIONS' : 'FULL DATA'}`;
        
        let headers = (category === 'BULK') ? ["DATE", "ID", "LOCO", "STN", "TIME", "SIG", "SPD", "DIR", "ASPECT", "CONCLUSION", "DIST", "ESTB", "LP ID", "LP NAME", "TRAIN", "TYPE", "ALP ID", "ALP NAME"] : ["SN", "CLI NAME", "ANALYSIS DATE", "WORKING DATE", "FROM", "TO", "TRAIN", "LOCO", "HQ", "LP NAME", "ALP NAME", "VIOLATION REMARK"];

        let html = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
        filtered.forEach(row => { html += `<tr>${row.map(cell => `<td>${cell || '-'}</td>`).join('')}</tr>`; });
        html += `</tbody></table>`;
        document.getElementById('tableContainer').innerHTML = html;

        document.getElementById('downloadBtn').onclick = () => {
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + filtered.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${category}_report.csv`);
            document.body.appendChild(link);
            link.click();
        };
    }

    function openMerit(type, rank) {
        const modal = document.getElementById('dataModal');
        modal.style.display = 'flex';
        const stats = {};
        
        // Combine data for Merit but EXCLUDE "TELOC CELL" from CLI lists
        [...database.SPM, ...database.CVVRS, ...database.TELOC].forEach(d => {
            const name = type === 'CLI' ? d[1] : d[9];
            // STRCIT FILTER: Skip if name is TELOC CELL
            if (!name || name === '-' || name.toUpperCase().includes("TELOC CELL")) return;
            
            if (!stats[name]) stats[name] = { count: 0, vios: 0 };
            stats[name].count++;
            if (d[11] && d[11].toUpperCase() !== 'NIL') stats[name].vios++;
        });

        let sorted = Object.entries(stats).sort((a, b) => {
            const rA = a[1].vios / a[1].count, rB = b[1].vios / b[1].count;
            if (rank === 'BEST') return (type === 'LP' ? rA - rB : b[1].count - a[1].count);
            return (type === 'LP' ? rB - rA : a[1].count - b[1].count);
        }).slice(0, 5);

        document.getElementById('modalTitle').innerText = `${rank} 05 ${type} PERFORMANCE (EXCL. TELOC CELL)`;
        let html = `<table><thead><tr><th>RANK</th><th>${type} NAME</th><th>TOTAL ANALYSIS</th><th>VIOLATIONS</th></tr></thead><tbody>`;
        sorted.forEach((item, idx) => { html += `<tr><td>${idx+1}</td><td><b>${item[0]}</b></td><td>${item[1].count}</td><td>${item[1].vios}</td></tr>`; });
        document.getElementById('tableContainer').innerHTML = html + `</tbody></table>`;
        document.getElementById('downloadBtn').style.display = 'none'; // Hide DL for Merit
    }
</script>
</body>
</html>
