<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SECR | TELOC EYE PRO</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --rail-blue: #003399; --rail-red: #d11212; --bg: #f0f4f8; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
    
    /* Compact Header */
    .master-header { display: flex; align-items: center; background: white; padding: 10px 30px; border-bottom: 4px solid var(--rail-red); border-radius: 10px; margin-bottom: 20px; height: 80px; }
    .logo-left { height: 70px; margin-right: 25px; }
    .header-titles h1 { font-size: 1.8rem; color: var(--rail-blue); margin: 0; font-weight: 900; }
    .header-titles h2 { font-size: 1.1rem; color: #444; margin: 0; }

    /* KPI Cards with Dual Labels */
    .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid var(--rail-blue); }
    .card h3 { font-size: 1.05rem; color: #1e293b; margin: 0 0 15px 0; font-weight: 800; }
    
    .stat-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .stat-val { text-align: center; }
    .stat-val div { font-size: 1.5rem; font-weight: 800; }
    .stat-val label { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; }

    .btn-group { display: flex; gap: 8px; }
    .btn { flex: 1; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 0.7rem; color: white; }
    .btn-rep { background: #0284c7; }
    .btn-vio { background: #e11d48; }

    .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .graph-card { background: white; padding: 12px; border-radius: 10px; height: 180px; border: 1px solid #ddd; }
    .graph-card h4 { margin: 0 0 8px 0; font-size: 0.75rem; color: #444; text-transform: uppercase; }

    .search-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .search-box { 
      height: 180px; border-radius: 15px; background: #2d3748; background-size: cover; 
      position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; overflow: hidden;
    }
    .search-box::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.6); }
    .search-box * { z-index: 5; }
    .search-input { width: 80%; padding: 10px; border-radius: 6px; border: none; margin-top: 10px; }

    .watermark { position: fixed; bottom: 8px; right: 20px; font-size: 0.65rem; font-weight: 800; color: #94a3b8; }
  </style>
</head>
<body>

  <div class="master-header">
    <img src="https://upload.wikimedia.org/wikipedia/en/thumb/4/41/South_East_Central_Railway_Logo.png/220px-South_East_Central_Railway_Logo.png" class="logo-left">
    <div class="header-titles">
      <h1>SOUTH EAST CENTRAL RAILWAY</h1>
      <h2>ELECTRICAL (OP) DEPARTMENT, RAIPUR DIVISION</h2>
    </div>
    <input type="date" id="datePicker" onchange="loadData()" style="margin-left:auto;">
  </div>

  <div class="kpi-row">
    <div class="card">
      <h3>Speedometer Analysis</h3>
      <div class="stat-box">
        <div class="stat-val"><label>Total</label><div id="v1_t">0</div></div>
        <div class="stat-val" style="color:#e11d48"><label>Violation</label><div id="v1_v">0</div></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-rep" onclick="openTable('SPM', false)">REPORT</button>
        <button class="btn btn-vio" onclick="openTable('SPM', true)">VIOLATION</button>
      </div>
    </div>
    <div class="card">
      <h3>CVVRS Analysis</h3>
      <div class="stat-box">
        <div class="stat-val"><label>Total</label><div id="v2_t">0</div></div>
        <div class="stat-val" style="color:#e11d48"><label>Violation</label><div id="v2_v">0</div></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-rep" onclick="openTable('CVVRS', false)">REPORT</button>
        <button class="btn btn-vio" onclick="openTable('CVVRS', true)">VIOLATION</button>
      </div>
    </div>
    <div class="card">
      <h3>TELOC Cell Analysis</h3>
      <div class="stat-box">
        <div class="stat-val"><label>Total</label><div id="v4_t">0</div></div>
        <div class="stat-val" style="color:#e11d48"><label>Violation</label><div id="v4_v">0</div></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-rep" onclick="openTable('TELOC', false)">REPORT</button>
        <button class="btn btn-vio" onclick="openTable('TELOC', true)">VIOLATION</button>
      </div>
    </div>
    <div class="card">
      <h3>Bulk Analysis</h3>
      <div class="stat-box">
        <div class="stat-val"><label>Progress</label><div id="v3_t">0</div></div>
        <div class="stat-val" style="color:#e11d48"><label>Violation</label><div id="v3_v">0</div></div>
      </div>
      <div class="btn-group">
        <button class="btn btn-rep" onclick="openTable('BULK', false)">REPORT</button>
        <button class="btn btn-vio" onclick="openTable('BULK', true)">VIOLATION</button>
      </div>
    </div>
  </div>

  <div class="main-grid">
    <div class="graph-card"><h4>SPM Analysis Progress</h4><canvas id="c1"></canvas></div>
    <div class="graph-card"><h4>CVVRS Analysis Progress</h4><canvas id="c2"></canvas></div>
    <div class="graph-card"><h4>TELOC Cell Progress</h4><canvas id="c4"></canvas></div>
    <div class="graph-card"><h4>Bulk Analysis Progress</h4><canvas id="c3"></canvas></div>
  </div>

  <div class="search-row">
    <div class="search-box" style="background-image:url('https://images.unsplash.com/photo-1515165562839-978bbcf18277?q=80&w=400')">
      <h3>CHIEF LOCO INSPECTOR</h3><p>MONITORING</p>
      <input type="text" list="cliL" class="search-input" placeholder="Search CLI Name..." onchange="goSearch(this.value, 'CLI')">
      <datalist id="cliL"></datalist>
    </div>
    <div class="search-box" style="background-image:url('https://images.unsplash.com/photo-1541427468627-a89a9b1f99d9?q=80&w=400')">
      <h3>LOCO PILOTS</h3><p>PERFORMANCE</p>
      <input type="text" list="lpL" class="search-input" placeholder="Search LP Name..." onchange="goSearch(this.value, 'LP')">
      <datalist id="lpL"></datalist>
    </div>
  </div>

  <div class="watermark">DEVELOPED BY CLI/TELOC/BMY</div>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbxTyVB2Zap5u2QgRy39mEnjOIZ0bcXH-rkdLFYLPoykZ7zK4dDOnBB5RCKMGvGT4cYHIA/exec"; 
    let charts = {};

    async function loadData() {
      const date = document.getElementById('datePicker').value;
      const res = await fetch(`${API}?date=${date}`);
      const d = await res.json();
      
      document.getElementById('v1_t').innerText = d.snapshot.spm_total;
      document.getElementById('v1_v').innerText = d.snapshot.spm_vio;
      document.getElementById('v2_t').innerText = d.snapshot.cvvrs_total;
      document.getElementById('v2_v').innerText = d.snapshot.cvvrs_vio;
      document.getElementById('v3_t').innerText = d.snapshot.bulk_total;
      document.getElementById('v3_v').innerText = d.snapshot.bulk_vio;
      document.getElementById('v4_t').innerText = d.snapshot.teloc_total;
      document.getElementById('v4_v').innerText = d.snapshot.teloc_vio;

      const opt = { type: 'bar', barThickness: 6, borderRadius: 2 };
      renderChart('c1', d.trends.dates, d.trends.spm, '#0284c7', opt);
      renderChart('c2', d.trends.dates, d.trends.cvvrs, '#10b981', opt);
      renderChart('c3', d.trends.dates, d.trends.bulk, '#f59e0b', opt);
      renderChart('c4', d.trends.dates, d.trends.teloc, '#e11d48', opt);

      document.getElementById('cliL').innerHTML = d.cli_list.map(n => `<option value="${n}">`).join('');
      document.getElementById('lpL').innerHTML = d.lp_list.map(n => `<option value="${n}">`).join('');
    }

    function renderChart(id, x, y, color, opt) {
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type: opt.type,
        data: { labels: x, datasets: [{ data: y, backgroundColor: color, ...opt }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, 
          scales: { x: { grid: { display: false }, ticks: { minRotation: 0, maxRotation: 0, font: {size: 9} } }, y: { beginAtZero: true } } }
      });
    }

    function openTable(type, onlyVio) {
      const d = document.getElementById('datePicker').value;
      window.open(`report.html?action=fullTable&date=${d}&type=${type}&onlyViolations=${onlyVio}`, '_blank');
    }

    function goSearch(name, role) {
      if(!name) return;
      window.open(`report.html?action=search&name=${encodeURIComponent(name)}&role=${role}`, '_blank');
    }

    document.getElementById('datePicker').value = "2026-01-02";
    loadData();
  </script>
</body>
</html>
