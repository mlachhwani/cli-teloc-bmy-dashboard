<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SECR | TELOC EYE</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary: #2563eb; --bg: #f8fafc; --border: #e2e8f0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; font-size: 14px; }
    .header { display: flex; align-items: center; background: white; padding: 15px 25px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
    .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
    .glass-card { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border: 1px solid var(--border); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .layout { display: grid; grid-template-columns: 1.2fr 0.6fr 1.2fr; gap: 20px; }
    .graph-card { background: white; padding: 15px; border-radius: 16px; border: 1px solid var(--border); height: 230px; margin-bottom: 20px; }
    .center-panel { background: white; border: 1px solid var(--border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; gap: 30px; align-items: center; justify-content: center; }
    .pie-box { width: 100px; height: 100px; margin-bottom: 10px; }
    .search-in { width: 90%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; outline: none; }
    .watermark { position: fixed; bottom: 10px; right: 20px; font-size: 10px; font-weight: 800; color: #94a3b8; letter-spacing: 1px; }
  </style>
</head>
<body>
  <div class="header">
    <div><b style="color:#1e3a8a; font-size:1.2rem;">SOUTH EAST CENTRAL RAILWAY</b><br><small>ELECTRICAL (OP) DEPARTMENT â€¢ RAIPUR</small></div>
    <input type="date" id="datePicker" onchange="loadData()" style="margin-left:auto; padding:5px;">
  </div>

  <div class="kpi-row">
    <div class="glass-card"><small>SPM</small><div id="v1" style="font-size:1.8rem; font-weight:800;">0</div></div>
    <div class="glass-card"><small>CVVRS</small><div id="v2" style="font-size:1.8rem; font-weight:800;">0</div></div>
    <div class="glass-card"><small>BULK</small><div id="v3" style="font-size:1.8rem; font-weight:800;">0</div></div>
    <div class="glass-card" style="border-bottom: 4px solid #ef4444;"><small>VIOLATIONS</small><div id="v4" style="font-size:1.8rem; font-weight:800; color:#ef4444;">0</div></div>
  </div>

  <div class="layout">
    <div class="side">
      <div class="graph-card"><canvas id="c1"></canvas></div>
      <div class="graph-card"><canvas id="c3"></canvas></div>
    </div>
    <div class="center-panel">
      <div style="text-align:center; width:100%;">
        <div class="pie-box" style="margin:auto;"><canvas id="p1"></canvas></div>
        <b>CLI</b><br><input type="text" list="cliL" class="search-in" onchange="go(this.value, 'CLI')"><datalist id="cliL"></datalist>
      </div>
      <div style="text-align:center; width:100%;">
        <div class="pie-box" style="margin:auto;"><canvas id="p2"></canvas></div>
        <b>LP</b><br><input type="text" list="lpL" class="search-in" onchange="go(this.value, 'LP')"><datalist id="lpL"></datalist>
      </div>
    </div>
    <div class="side">
      <div class="graph-card"><canvas id="c2"></canvas></div>
      <div class="graph-card"><canvas id="c4"></canvas></div>
    </div>
  </div>
  <div class="watermark">DEVELOPED BY CLI/TELOC/BMY</div>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbxg3mEv6z_2KS4gPkUuVlQGDWZx214Mb4haDkCc7z0YXfPcJXIQNRQ53p7saPM4O3elzw/exec";
    let charts = {};

    async function loadData() {
      const res = await fetch(`${API}?date=${document.getElementById('datePicker').value}`);
      const d = await res.json();
      document.getElementById('v1').innerText = d.snapshot.spm_today;
      document.getElementById('v2').innerText = d.snapshot.cvvrs_today;
      document.getElementById('v3').innerText = d.snapshot.bulk_today;
      document.getElementById('v4').innerText = d.snapshot.violations;

      render('c1', 'SPM', d.trends.dates, d.trends.spm, '#2563eb');
      render('c2', 'CVVRS', d.trends.dates, d.trends.cvvrs, '#10b981');
      render('c3', 'BULK', d.trends.dates, d.trends.bulk, '#f59e0b');
      render('c4', 'VIOLATIONS', d.trends.dates, d.trends.teloc, '#ef4444');
      
      renderPie('p1', [d.snapshot.spm_today, d.snapshot.cvvrs_today], ['#2563eb', '#93c5fd']);
      renderPie('p2', [d.snapshot.violations, d.snapshot.bulk_today], ['#ef4444', '#fecaca']);

      document.getElementById('cliL').innerHTML = d.cli_list.map(n => `<option value="${n}">`).join('');
      document.getElementById('lpL').innerHTML = d.lp_list.map(n => `<option value="${n}">`).join('');
    }

    function render(id, label, x, y, color) {
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type: 'bar',
        data: { labels: x, datasets: [{ label: label, data: y, backgroundColor: color, borderRadius: 4, barThickness: 6 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { beginAtZero: true } } }
      });
    }

    function renderPie(id, vals, colors) {
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type: 'doughnut',
        data: { datasets: [{ data: vals, backgroundColor: colors, borderWidth: 0 }] },
        options: { cutout: '70%', responsive: true, maintainAspectRatio: false }
      });
    }

    function go(v, t) { if(v) window.open(`report.html?name=${encodeURIComponent(v)}&type=${t}`, '_blank'); }
    document.getElementById('datePicker').value = "2026-01-02";
    loadData();
  </script>
</body>
</html>
