<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECR RAIPUR | PREMIERE ANALYTICS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #f0f2f5; 
            --header: #0f172a; 
            --accent: #3b82f6; 
            --text-main: #1e293b;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: var(--text-main); }
        header { 
            background: var(--header); padding: 15px 40px; 
            display: flex; justify-content: space-between; align-items: center; 
            color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-weight: 800; font-size: 1.5rem; background: linear-gradient(to right, #60a5fa, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .container { max-width: 1500px; margin: 30px auto; padding: 0 25px; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 40px; }
        .card { 
            background: white; border-radius: 24px; padding: 25px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.03); 
            border: 1px solid rgba(255,255,255,0.8);
            transition: all 0.4s ease;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .card h3 { font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin: 0 0 10px 0; letter-spacing: 1.5px; font-weight: 700; }
        .card .count { font-size: 2.8rem; font-weight: 800; color: var(--header); margin-bottom: 15px; display: block; }
        .graph-area { height: 180px; margin-bottom: 20px; cursor: zoom-in; border-radius: 12px; background: #ffffff; padding: 10px; border: 1px solid #f1f5f9; }
        .btn-group { display: flex; gap: 8px; }
        .btn { flex: 1; padding: 12px; border-radius: 14px; border: none; font-weight: 700; font-size: 0.75rem; cursor: pointer; transition: 0.3s; }
        .btn-details { background: var(--header); color: white; }
        .btn-vio { background: #fee2e2; color: #dc2626; }
        .performer-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 40px; }
        .icon-btn { background: var(--header); color: white; padding: 30px; border-radius: 24px; text-align: center; cursor: pointer; transition: 0.3s; }
        .icon-btn:hover { background: #1e293b; transform: scale(1.02); }
        .icon-btn span { display: block; margin-top: 10px; font-weight: 700; font-size: 0.9rem; }
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(10px); }
        .modal-content { background: white; width: 95%; max-height: 90vh; border-radius: 32px; padding: 40px; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 25px; right: 35px; font-size: 2.5rem; cursor: pointer; color: #94a3b8; }
        .table-wrapper { margin-top: 25px; border-radius: 16px; overflow: hidden; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; text-align: center; background: white; }
        th { padding: 16px; background: #f1f5f9; border: 1px solid #e2e8f0; font-size: 0.75rem; font-weight: 800; color: #475569; }
        td { padding: 14px; border: 1px solid #f1f5f9; font-size: 0.85rem; color: #1e293b; }
        input { padding: 12px; border-radius: 12px; border: 1px solid #cbd5e1; font-weight: 600; }
    </style>
</head>
<body>

<header>
    <div class="logo">SECR ANALYTICS ENGINE</div>
    <div style="display:flex; gap:15px; align-items:center;">
        <input type="date" id="globalDate" onchange="refreshDashboard()">
        <button onclick="resetToMonthly()" style="padding:12px 20px; border-radius:12px; border:none; background:var(--accent); color:white; font-weight:bold; cursor:pointer;">Full Month View</button>
    </div>
</header>

<div class="container">
    <div class="summary-grid">
        <div class="card">
            <h3>SPM / RTIS Monitoring</h3>
            <span class="count" id="countSPM">0</span>
            <div class="graph-area" onclick="zoomGraph('SPM')"><canvas id="chartSPM"></canvas></div>
            <div class="btn-group">
                <button class="btn btn-details" onclick="openDataWindow('SPM', false)">DETAILS</button>
                <button class="btn btn-vio" onclick="openDataWindow('SPM', true)">VIOLATIONS</button>
            </div>
        </div>
        <div class="card">
            <h3>CVVRS Performance</h3>
            <span class="count" id="countCV">0</span>
            <div class="graph-area" onclick="zoomGraph('CVVRS')"><canvas id="chartCV"></canvas></div>
            <div class="btn-group">
                <button class="btn btn-details" onclick="openDataWindow('CVVRS', false)">DETAILS</button>
                <button class="btn btn-vio" onclick="openDataWindow('CVVRS', true)">VIOLATIONS</button>
            </div>
        </div>
        <div class="card">
            <h3>TELOC Cell Audit</h3>
            <span class="count" id="countTL">0</span>
            <div class="graph-area" onclick="zoomGraph('TELOC')"><canvas id="chartTL"></canvas></div>
            <div class="btn-group">
                <button class="btn btn-details" onclick="openDataWindow('TELOC', false)">DETAILS</button>
                <button class="btn btn-vio" onclick="openDataWindow('TELOC', true)">VIOLATIONS</button>
            </div>
        </div>
        <div class="card">
            <h3>Bulk Auto Analysis</h3>
            <span class="count" id="countBK">0</span>
            <div class="graph-area" onclick="zoomGraph('BULK')"><canvas id="chartBK"></canvas></div>
            <div class="btn-group">
                <button class="btn btn-details" onclick="openDataWindow('BULK', false)">DETAILS</button>
                <button class="btn btn-vio" onclick="openDataWindow('BULK', true)">VIOLATIONS</button>
            </div>
        </div>
    </div>

    <div class="performer-section">
        <div class="icon-btn" onclick="openMerit('CLI', 'BEST')">ü•á <span>TOP 5 CLI</span></div>
        <div class="icon-btn" onclick="openMerit('LP', 'BEST')">üèÜ <span>BEST LP (SAFE)</span></div>
        <div class="icon-btn" onclick="openMerit('CLI', 'WORST')">‚ö†Ô∏è <span>ATTN NEEDED (CLI)</span></div>
        <div class="icon-btn" onclick="openMerit('LP', 'WORST')">üî¥ <span>WORST LP (VIO)</span></div>
    </div>
</div>

<div class="modal" id="dataModal">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('dataModal').style.display='none'">&times;</span>
        <h2 id="modalTitle" style="margin-top:0; font-weight:800; color:var(--header);">Report</h2>
        <div id="modalExtra" style="margin-bottom:20px;"></div>
        <div class="table-wrapper" id="tableContainer"></div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    const GITHUB_PATH = "https://raw.githubusercontent.com/mlachhwani/cli-teloc-bmy-dashboard/main/data/2026-01";
    let database = { SPM: [], CVVRS: [], TELOC: [], BULK: [], BULK_VIO: [] };
    let charts = {};

    window.onload = async () => {
        await Promise.all([fetchCSV('spm.csv', 'SPM'), fetchCSV('cvvrs.csv', 'CVVRS'), fetchCSV('teloc_daily.csv', 'TELOC'), fetchCSV('bulk_analysis.csv', 'BULK'), fetchCSV('bulk_violation_details.csv', 'BULK_VIO')]);
        refreshDashboard();
    };

    async function fetchCSV(file, key) {
        try {
            const res = await fetch(`${GITHUB_PATH}/${file}`);
            const text = await res.text();
            database[key] = text.split('\n').filter(l => l.trim() !== "").slice(1).map(row => {
                const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || row.split(',');
                return cols.map(v => v.trim().replace(/"/g, ''));
            });
        } catch (e) { console.error("Error loading " + file); }
    }

    function resetToMonthly() { document.getElementById('globalDate').value = ""; refreshDashboard(); }

    function refreshDashboard() {
        const selDate = document.getElementById('globalDate').value;
        ['SPM', 'CVVRS', 'TELOC'].forEach(k => {
            const countId = k === 'CVVRS' ? 'countCV' : k === 'TELOC' ? 'countTL' : 'countSPM';
            document.getElementById(countId).innerText = selDate ? database[k].filter(d => d[2] === selDate).length : database[k].length;
            renderChart(`chart${k === 'CVVRS' ? 'CV' : k === 'TELOC' ? 'TL' : 'SPM'}`, database[k], false);
        });
        const bTot = selDate ? (database.BULK.find(d => d[0] === selDate)?.[1] || 0) : database.BULK.reduce((s, r) => s + (parseInt(r[1]) || 0), 0);
        document.getElementById('countBK').innerText = bTot;
        renderChart('chartBK', database.BULK, true);
    }

    function renderChart(canvasId, data, isBulk, isZoomed = false) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();

        const dates = [...new Set(data.map(d => d[isBulk ? 0 : 2]))].sort();
        const totals = dates.map(d => isBulk ? (parseInt(data.find(r => r[0] === d)?.[1]) || 0) : data.filter(r => r[2] === d).length);
        const vios = dates.map(d => isBulk ? (parseInt(data.find(r => r[0] === d)?.[2]) || 0) : data.filter(r => r[2] === d && r[11] && r[11].toUpperCase() !== 'NIL').length);

        charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates.map(d => d.split('-')[2]),
                datasets: [
                    { label: 'Violations', data: vios, backgroundColor: '#dc2626', barThickness: isZoomed ? 25 : 5 },
                    { label: 'Total', data: totals, backgroundColor: '#cbd5e1', barThickness: isZoomed ? 25 : 5 }
                ]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'top', offset: -2, color: '#475569', font: { weight: 'bold', size: isZoomed ? 11 : 8 },
                        display: (context) => context.dataset.label === 'Total' && context.dataset.data[context.dataIndex] > 0
                    }
                },
                scales: { 
                    x: { stacked: true, grid: { display: false } }, 
                    y: { 
                        display: true, // Y-AXIS IS NOW ALWAYS VISIBLE
                        beginAtZero: true,
                        grid: { color: '#f1f5f9' },
                        ticks: { font: { size: 9, weight: '600' }, color: '#94a3b8' }
                    } 
                },
                maintainAspectRatio: false
            }
        });
    }

    function zoomGraph(category) {
        const modal = document.getElementById('dataModal'); modal.style.display = 'flex';
        document.getElementById('modalTitle').innerText = `Monthly Trend: ${category}`;
        document.getElementById('modalExtra').innerHTML = `<div style="height:450px; width:100%"><canvas id="zoomedChart"></canvas></div>`;
        const data = (category === 'BULK') ? database.BULK : database[category];
        setTimeout(() => renderChart('zoomedChart', data, category === 'BULK', true), 100);
        document.getElementById('tableContainer').innerHTML = "";
    }

    function openDataWindow(category, onlyVios) {
        const date = document.getElementById('globalDate').value;
        const modal = document.getElementById('dataModal'); modal.style.display = 'flex';
        document.getElementById('modalExtra').innerHTML = "";
        let filtered = (category === 'BULK') ? database.BULK_VIO : database[category];
        if (date) filtered = filtered.filter(d => d[category === 'BULK' ? 0 : 2] === date);
        if (onlyVios && category !== 'BULK') filtered = filtered.filter(d => d[11] && d[11].toUpperCase() !== 'NIL');
        let headers = (category === 'BULK') ? ["DATE", "LOCO", "STN", "TIME", "SPD", "ASPECT", "LP NAME", "TRAIN"] : ["SN", "CLI", "ANL_DATE", "WRK_DATE", "TRAIN", "LOCO", "LP", "ALP", "REMARK"];
        let html = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${filtered.map(r => `<tr>${r.slice(0, headers.length).map(c => `<td>${c || '-'}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
        document.getElementById('tableContainer').innerHTML = html;
        document.getElementById('modalTitle').innerText = `${category} Report`;
    }

    function openMerit(type, rank) {
        const modal = document.getElementById('dataModal'); modal.style.display = 'flex';
        document.getElementById('modalExtra').innerHTML = "";
        const stats = {};
        [...database.SPM, ...database.CVVRS, ...database.TELOC].forEach(d => {
            const name = type === 'CLI' ? d[1] : d[9];
            if (!name || name === '-' || name.toUpperCase().includes("TELOC CELL")) return;
            if (!stats[name]) stats[name] = { count: 0, vios: 0 };
            stats[name].count++; if (d[11] && d[11].toUpperCase() !== 'NIL') stats[name].vios++;
        });
        let sorted = Object.entries(stats).sort((a, b) => { 
            const rA = a[1].vios / a[1].count, rB = b[1].vios / b[1].count; 
            return (rank === 'BEST') ? (type === 'LP' ? rA - rB : b[1].count - a[1].count) : (type === 'LP' ? rB - rA : a[1].count - b[1].count); 
        }).slice(0, 5);
        let html = `<table><thead><tr><th>RANK</th><th>NAME</th><th>TOTAL</th><th>VIOS</th></tr></thead><tbody>${sorted.map((item, idx) => `<tr><td>#${idx+1}</td><td><b>${item[0]}</b></td><td>${item[1].count}</td><td>${item[1].vios}</td></tr>`).join('')}</tbody></table>`;
        document.getElementById('tableContainer').innerHTML = html;
        document.getElementById('modalTitle').innerText = `${rank} 05 ${type}`;
    }
</script>
</body>
</html>
