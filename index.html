<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECR RAIPUR | PERFORMANCE DASHBOARD</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f3f4f6; --header-bg: #0f172a; --accent-blue: #3b82f6; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: #1e293b; }
        header { background: var(--header-bg); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; color: white; position: sticky; top: 0; z-index: 1000; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .ir-logo { height: 60px; width: auto; }
        .main-title { font-weight: 800; font-size: 1.3rem; background: linear-gradient(to right, #60a5fa, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; }
        .sub-title { font-weight: 600; font-size: 0.8rem; color: #ffffff; }

        .container { max-width: 1500px; margin: 30px auto; padding: 0 25px; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        
        /* Interactive Cards */
        .card { 
            background: white; border-radius: 20px; padding: 20px; 
            border-top: 5px solid var(--accent-blue); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: default;
        }
        .card:hover { 
            transform: translateY(-10px) scale(1.02); 
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.15);
            border-top-width: 8px;
        }
        .card .count { font-size: 2.5rem; font-weight: 800; color: var(--header-bg); margin: 10px 0; display: block; }
        
        /* Graph Interaction */
        .graph-area { 
            height: 160px; cursor: zoom-in; background: #fff; 
            margin-bottom: 15px; border-radius: 10px; padding: 5px;
            transition: background 0.3s;
        }
        .graph-area:hover { background: #f8fafc; }

        .performer-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 30px; }
        .icon-btn { background: var(--header-bg); color: white; padding: 20px 10px; border-radius: 15px; text-align: center; cursor: pointer; transition: 0.3s; font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.1); }
        .icon-btn:hover { background: #1e293b; transform: scale(1.05); border-color: var(--accent-blue); }
        .icon-btn b { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #60a5fa; }

        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); }
        .modal-content { background: white; width: 95%; max-height: 90vh; border-radius: 20px; padding: 30px; overflow-y: auto; position: relative; }
        
        /* Darker Table Lines */
        table { width: 100%; border-collapse: collapse; text-align: center; margin-top: 10px; border: 2px solid #475569; }
        th { padding: 12px; background: #334155; border: 2px solid #475569; font-size: 0.75rem; font-weight: 800; color: white; }
        td { padding: 10px; border: 1.5px solid #64748b; font-size: 0.8rem; font-weight: 600; color: #1e293b; }
        tr:nth-child(even) { background-color: #f1f5f9; }
        tr:hover { background-color: #e2e8f0; }

        .dl-group { margin-bottom: 15px; display: flex; gap: 10px; }
        .dl-btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 0.7rem; color: white; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="ir_logo.png" alt="IR Logo" class="ir-logo">
        <div style="display:flex; flex-direction:column;">
            <span class="main-title">SOUTH EAST CENTRAL RAILWAY</span>
            <span class="sub-title">ELECTRICAL (OP) DEPARTMENT, RAIPUR DIVISION</span>
        </div>
    </div>
    <div style="display:flex; gap:10px;">
        <input type="date" id="globalDate" onchange="refreshDashboard()" style="padding:8px; border-radius:8px; border:1px solid #cbd5e1;">
        <button onclick="resetToMonthly()" style="padding:8px 15px; border-radius:8px; background:var(--accent-blue); color:white; border:none; cursor:pointer; font-weight:700;">Full Month</button>
    </div>
</header>

<div class="container">
    <div class="summary-grid" id="mainGrid"></div>
    <div class="performer-section">
        <div class="icon-btn" onclick="openMerit('CLI', 'BEST')"><b>ü•á TOP FIVE</b> PERFORMER (CLI)</div>
        <div class="icon-btn" onclick="openMerit('LP', 'BEST')"><b>üèÜ TOP FIVE</b> PERFORMER (LP)</div>
        <div class="icon-btn" onclick="openMerit('CLI', 'WORST')"><b>‚ö†Ô∏è CLIs</b> TELLENDERS (Bottom 5)</div>
        <div class="icon-btn" onclick="openMerit('LP', 'WORST')"><b>üî¥ LPs</b> NEEDS ATTENTION (Bottom 5)</div>
    </div>
</div>

<div class="modal" id="dataModal">
    <div class="modal-content">
        <span onclick="closeModal()" style="float:right; cursor:pointer; font-size:2.5rem; font-weight:bold; color:#64748b;">&times;</span>
        <h2 id="modalTitle" style="margin-top:0; border-bottom:3px solid var(--accent-blue); padding-bottom:10px;">Report</h2>
        <div id="dlGroup" class="dl-group" style="display:none;">
            <button class="dl-btn" style="background:#be123c;" onclick="exportPDF()">Download PDF</button>
            <button class="dl-btn" style="background:#15803d;" onclick="exportExcel()">Download Excel</button>
        </div>
        <div id="modalExtra"></div>
        <div id="tableContainer"></div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    const GITHUB_PATH = "https://raw.githubusercontent.com/mlachhwani/cli-teloc-bmy-dashboard/main/data/2026-01";
    let database = { SPM: [], CVVRS: [], TELOC: [], BULK: [], BULK_VIO: [] };
    let currentFilteredData = [], currentHeaders = [], activeCharts = {};

    window.onload = async () => {
        await Promise.all([fetchCSV('spm.csv', 'SPM'), fetchCSV('cvvrs.csv', 'CVVRS'), fetchCSV('teloc_daily.csv', 'TELOC'), fetchCSV('bulk_analysis.csv', 'BULK'), fetchCSV('bulk_violation_details.csv', 'BULK_VIO')]);
        initCards();
        refreshDashboard();
    };

    async function fetchCSV(f, k) {
        try {
            const res = await fetch(`${GITHUB_PATH}/${f}`);
            const text = await res.text();
            database[k] = text.split('\n').filter(l => l.trim() !== "").slice(1).map(row => {
                const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || row.split(',');
                return cols.map(v => v.trim().replace(/"/g, ''));
            });
        } catch (e) { console.error("Error: " + f); }
    }

    function initCards() {
        const cats = [{id:'SPM',t:'SPM / RTIS Analysis'}, {id:'CV',t:'CVVRS Analysis'}, {id:'TL',t:'TELOC CELL Audit'}, {id:'BK',t:'Bulk Auto-Analysis'}];
        document.getElementById('mainGrid').innerHTML = cats.map(c => `
            <div class="card">
                <h3>${c.t}</h3>
                <span class="count" id="count${c.id}">0</span>
                <div class="graph-area" onclick="zoomGraph('${c.id}')"><canvas id="chart${c.id}"></canvas></div>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button class="dl-btn" style="background:#0f172a; flex:1;" onclick="openDataWindow('${c.id}', false)">DETAILS</button>
                    <button class="dl-btn" style="background:#fee2e2; color:#dc2626; flex:1;" onclick="openDataWindow('${c.id}', true)">VIOLATIONS</button>
                </div>
            </div>`).join('');
    }

    function renderChart(canvasId, data, isBulk, isZoomed = false) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

        const dates = [...new Set(data.map(d => d[isBulk ? 0 : 2]))].sort();
        const totals = dates.map(d => isBulk ? (parseInt(data.find(r => r[0] === d)?.[1]) || 0) : data.filter(r => r[2] === d).length);
        const vios = dates.map(d => isBulk ? (parseInt(data.find(r => r[0] === d)?.[2]) || 0) : data.filter(r => r[2] === d && r[11] && r[11].toUpperCase() !== 'NIL').length);

        activeCharts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates.map(d => d.split('-')[2]),
                datasets: [
                    { label: 'Violations', data: vios, backgroundColor: '#dc2626', barThickness: isZoomed ? 30 : 6 },
                    { label: 'Total', data: totals, backgroundColor: '#cbd5e1', barThickness: isZoomed ? 30 : 6 }
                ]
            },
            options: {
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end', align: 'top', color: '#1e293b', font: { weight: '800', size: isZoomed ? 12 : 9 },
                        display: (ctx) => ctx.dataset.label === 'Total' && ctx.dataset.data[ctx.dataIndex] > 0
                    }
                },
                scales: { 
                    x: { stacked: true, grid: { display: false } }, 
                    y: { display: true, beginAtZero: true, grid: { color: '#e2e8f0' }, ticks: { font: { weight: 'bold' } } } 
                },
                maintainAspectRatio: false
            }
        });
    }

    function zoomGraph(cat) {
        const modal = document.getElementById('dataModal');
        modal.style.display = 'flex';
        document.getElementById('dlGroup').style.display = 'none';
        document.getElementById('modalTitle').innerText = `Detailed Trend: ${cat}`;
        document.getElementById('modalExtra').innerHTML = `<div style="height:450px; width:100%; margin-top:20px;"><canvas id="zoomedChart"></canvas></div>`;
        document.getElementById('tableContainer').innerHTML = "";
        
        const dbKey = cat === 'CV' ? 'CVVRS' : cat === 'TL' ? 'TELOC' : (cat === 'BK' ? 'BULK' : 'SPM');
        setTimeout(() => renderChart('zoomedChart', database[dbKey], cat === 'BK', true), 100);
    }

    function openDataWindow(cat, onlyVios) {
        document.getElementById('dataModal').style.display = 'flex';
        document.getElementById('modalExtra').innerHTML = "";
        document.getElementById('dlGroup').style.display = 'flex';
        const dbKey = cat === 'CV' ? 'CVVRS' : cat === 'TL' ? 'TELOC' : (cat === 'BK' ? 'BULK_VIO' : 'SPM');
        const selDate = document.getElementById('globalDate').value;
        let filtered = database[dbKey];
        if (selDate) filtered = filtered.filter(d => d[dbKey === 'BULK_VIO' ? 0 : 2] === selDate);
        if (onlyVios && dbKey !== 'BULK_VIO') filtered = filtered.filter(d => d[11] && d[11].toUpperCase() !== 'NIL');
        
        currentHeaders = dbKey === 'BULK_VIO' ? ["DATE", "LOCO", "STN", "TIME", "SPD", "ASPECT", "LP NAME", "TRAIN"] : ["SN", "CLI", "ANL_DATE", "WRK_DATE", "TRAIN", "LOCO", "LP", "ALP", "REMARK"];
        currentFilteredData = filtered.map(r => r.slice(0, currentHeaders.length));
        
        document.getElementById('modalTitle').innerText = `${cat} ${onlyVios ? 'VIOLATIONS' : 'FULL REPORT'}`;
        document.getElementById('tableContainer').innerHTML = `<table><thead><tr>${currentHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${currentFilteredData.map(r => `<tr>${r.map(c => `<td>${c || '-'}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
    }

    function refreshDashboard() {
        ['SPM', 'CV', 'TL'].forEach(k => {
            const dbKey = k === 'CV' ? 'CVVRS' : k === 'TL' ? 'TELOC' : 'SPM';
            const selDate = document.getElementById('globalDate').value;
            document.getElementById(`count${k}`).innerText = selDate ? database[dbKey].filter(d => d[2] === selDate).length : database[dbKey].length;
            renderChart(`chart${k}`, database[dbKey], false);
        });
        const bTot = document.getElementById('globalDate').value ? (database.BULK.find(d => d[0] === document.getElementById('globalDate').value)?.[1] || 0) : database.BULK.reduce((s, r) => s + (parseInt(r[1]) || 0), 0);
        document.getElementById('countBK').innerText = bTot;
        renderChart('chartBK', database.BULK, true);
    }

    function closeModal() { document.getElementById('dataModal').style.display = 'none'; if(activeCharts['zoomedChart']) activeCharts['zoomedChart'].destroy(); }
    function resetToMonthly() { document.getElementById('globalDate').value = ""; refreshDashboard(); }
    
    function exportExcel() { const ws = XLSX.utils.aoa_to_sheet([currentHeaders, ...currentFilteredData]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Report"); XLSX.writeFile(wb, "SECR_Report.xlsx"); }
    function exportPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); doc.autoTable({ head: [currentHeaders], body: currentFilteredData, theme: 'grid', styles: { fontSize: 7 } }); doc.save("SECR_Report.pdf"); }
</script>
</body>
</html>
