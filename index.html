<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECR RAILWAY - OPERATIONAL DASHBOARD</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e293b; --accent: #2563eb; --danger: #dc2626; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: var(--primary); }
        
        /* Sidebar & Header */
        header { background: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        .logo { font-weight: 800; font-size: 1.4rem; color: var(--accent); letter-spacing: -0.5px; }
        
        /* Container */
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        
        /* Summary Grid */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .card { background: var(--card); border-radius: 24px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; }
        .card h3 { font-size: 0.85rem; text-transform: uppercase; color: #64748b; margin: 0 0 15px 0; }
        .card .count { font-size: 2.2rem; font-weight: 800; margin-bottom: 20px; display: block; }
        
        /* Graph Area */
        .graph-mini { height: 120px; margin-bottom: 20px; }
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 10px; border-radius: 12px; border: none; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
        .btn-details { background: #f1f5f9; color: #475569; }
        .btn-vio { background: #fee2e2; color: #dc2626; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }

        /* Icon Buttons Section */
        .performer-section { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 40px; }
        .icon-btn { background: white; padding: 30px; border-radius: 24px; text-align: center; cursor: pointer; border: 1px solid #e2e8f0; transition: 0.3s; }
        .icon-btn:hover { border-color: var(--accent); background: #f0f7ff; }
        .icon-btn span { display: block; margin-top: 15px; font-weight: 700; font-size: 0.9rem; }

        /* Modal / Window */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 90%; max-height: 90vh; border-radius: 30px; padding: 40px; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 25px; right: 25px; font-size: 2rem; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 15px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; font-size: 0.8rem; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <div class="logo">SECR RAIPUR | OPS DASHBOARD</div>
    <div style="display:flex; gap:20px; align-items:center;">
        <span style="font-weight:600; color:#64748b;">Select Date:</span>
        <input type="date" id="globalDate" value="2026-01-04" onchange="refreshDashboard()" style="padding:10px; border-radius:10px; border:1px solid #ddd; font-weight:bold;">
    </div>
</header>

<div class="container">
    <div class="summary-grid">
        <div class="card">
            <h3>Speedometer / RTIS</h3>
            <span class="count" id="countSPM">0</span>
            <div class="graph-mini"><canvas id="chartSPM"></canvas></div>
            <div class="btn-group">
                <button class="btn btn-details" onclick="openDataWindow('SPM', false)">FULL DETAILS</button>
                <button class="btn btn-vio" onclick="openDataWindow('SPM', true)">VIOLATIONS</button>
            </div>
        </div>
        <div class="card">
            <h3>CVVRS Analysis</h3>
            <span class="count" id="countCV">0</span>
            <div class="graph-mini"><canvas id="chartCV"></canvas></div>
            <div class="btn-group">
                <button class="btn btn-details" onclick="openDataWindow('CVVRS', false)">FULL DETAILS</button>
                <button class="btn btn-vio" onclick="openDataWindow('CVVRS', true)">VIOLATIONS</button>
            </div>
        </div>
        <div class="card">
            <h3>TELOC Cell</h3>
            <span class="count" id="countTL">0</span>
            <div class="graph-mini"><canvas id="chartTL"></canvas></div>
            <div class="btn-group">
                <button class="btn btn-details" onclick="openDataWindow('TELOC', false)">FULL DETAILS</button>
                <button class="btn btn-vio" onclick="openDataWindow('TELOC', true)">VIOLATIONS</button>
            </div>
        </div>
        <div class="card">
            <h3>Bulk Analysis</h3>
            <span class="count" id="countBK">0</span>
            <div class="graph-mini"><canvas id="chartBK"></canvas></div>
            <div class="btn-group">
                <button class="btn btn-details" onclick="openDataWindow('BULK', false)">FULL DETAILS</button>
                <button class="btn btn-vio" onclick="openDataWindow('BULK', true)">VIOLATIONS</button>
            </div>
        </div>
    </div>

    <div class="performer-section">
        <div class="icon-btn" onclick="openMerit('CLI', 'BEST')">ü•á <span>BEST 05 CLI</span></div>
        <div class="icon-btn" onclick="openMerit('LP', 'BEST')">üèÜ <span>BEST 05 LP</span></div>
        <div class="icon-btn" onclick="openMerit('CLI', 'WORST')">‚ö†Ô∏è <span>WORST 05 CLI</span></div>
        <div class="icon-btn" onclick="openMerit('LP', 'WORST')">üî¥ <span>WORST 05 LP</span></div>
    </div>
</div>

<div class="modal" id="dataModal">
    <div class="modal-content">
        <span class="close-modal" onclick="document.getElementById('dataModal').style.display='none'">&times;</span>
        <h2 id="modalTitle" style="margin-top:0;">Report Details</h2>
        <button id="downloadBtn" style="padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">DOWNLOAD REPORT (CSV)</button>
        <div id="tableContainer"></div>
    </div>
</div>

<script>
    const GITHUB_PATH = "https://raw.githubusercontent.com/mlachhwani/cli-teloc-bmy-dashboard/main/data/2026-01";
    let database = { SPM: [], CVVRS: [], TELOC: [], BULK: [], BULK_VIO: [] };
    let charts = {};

    window.onload = async () => {
        await Promise.all([
            fetchCSV('spm.csv', 'SPM'),
            fetchCSV('cvvrs.csv', 'CVVRS'),
            fetchCSV('teloc_daily.csv', 'TELOC'),
            fetchCSV('bulk_analysis.csv', 'BULK'),
            fetchCSV('bulk_violation_details.csv', 'BULK_VIO')
        ]);
        refreshDashboard();
    };

    async function fetchCSV(file, key) {
        try {
            const res = await fetch(`${GITHUB_PATH}/${file}`);
            const text = await res.text();
            const lines = text.split('\n').filter(l => l.trim() !== "");
            const headers = lines[0].split(',');
            database[key] = lines.slice(1).map(row => {
                const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || row.split(',');
                return cols.map(v => v.trim().replace(/"/g, ''));
            });
        } catch (e) { console.error("Error loading " + file); }
    }

    function refreshDashboard() {
        const selDate = document.getElementById('globalDate').value;
        
        updateCard('SPM', selDate, 'countSPM', 'chartSPM');
        updateCard('CVVRS', selDate, 'countCV', 'chartCV');
        updateCard('TELOC', selDate, 'countTL', 'chartTL');
        updateBulkCard(selDate);
    }

    function updateCard(key, date, countId, chartId) {
        const fullData = database[key];
        const dayData = fullData.filter(d => d[2] === date); // Filter by Analysis Date (Index 2)
        document.getElementById(countId).innerText = dayData.length;
        renderStackedChart(chartId, fullData);
    }

    function updateBulkCard(date) {
        const dayBulk = database.BULK.find(d => d[0] === date);
        document.getElementById('countBK').innerText = dayBulk ? dayBulk[1] : 0;
        renderStackedChart('chartBK', database.BULK, true);
    }

    function renderStackedChart(canvasId, data, isBulk = false) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();

        const last7Days = [];
        for(let i=6; i>=0; i--) {
            let d = new Date(document.getElementById('globalDate').value);
            d.setDate(d.getDate() - i);
            last7Days.push(d.toISOString().split('T')[0]);
        }

        const totals = [], vios = [];
        last7Days.forEach(day => {
            if(isBulk) {
                const row = data.find(r => r[0] === day);
                totals.push(row ? parseInt(row[1]) : 0);
                vios.push(row ? parseInt(row[2]) : 0);
            } else {
                const rows = data.filter(r => r[2] === day);
                totals.push(rows.length);
                vios.push(rows.filter(r => r[11] && r[11].toUpperCase() !== 'NIL').length);
            }
        });

        charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: last7Days.map(d => d.split('-')[2]),
                datasets: [
                    { label: 'Violations', data: vios, backgroundColor: '#dc2626' },
                    { label: 'Total', data: totals.map((t, i) => t - vios[i]), backgroundColor: '#1e293b' }
                ]
            },
            options: { 
                scales: { x: { stacked: true, display: true }, y: { stacked: true, display: false } },
                plugins: { legend: { display: false } },
                maintainAspectRatio: false
            }
        });
    }

    function openDataWindow(category, onlyVios) {
        const date = document.getElementById('globalDate').value;
        const modal = document.getElementById('dataModal');
        const container = document.getElementById('tableContainer');
        modal.style.display = 'flex';
        
        let filtered = [];
        if (category === 'BULK') {
            filtered = onlyVios ? database.BULK_VIO.filter(d => d[0] === date) : database.BULK_VIO.filter(d => d[0] === date);
        } else {
            filtered = database[category].filter(d => d[2] === date);
            if (onlyVios) filtered = filtered.filter(d => d[11] && d[11].toUpperCase() !== 'NIL');
        }

        document.getElementById('modalTitle').innerText = `${category} - ${onlyVios ? 'VIOLATIONS' : 'FULL DETAILS'} (${date})`;
        
        let html = `<table><thead><tr>`;
        const headers = ["SN", "CLI", "DATE", "W-DATE", "FROM", "TO", "TRAIN", "LOCO", "HQ", "LP NAME", "ALP NAME", "REMARK"];
        headers.forEach(h => html += `<th>${h}</th>`);
        html += `</tr></thead><tbody>`;
        
        filtered.forEach(row => {
            html += `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
        
        document.getElementById('downloadBtn').onclick = () => {
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + filtered.map(e => e.join(",")).join("\n");
            window.open(encodeURI(csvContent));
        };
    }

    function openMerit(type, rank) {
        const modal = document.getElementById('dataModal');
        const container = document.getElementById('tableContainer');
        modal.style.display = 'flex';
        document.getElementById('modalTitle').innerText = `${rank} 05 ${type} PERFORMANCE (MONTHLY)`;

        const stats = {};
        const sources = [...database.SPM, ...database.CVVRS];
        if (type === 'LP') sources.push(...database.TELOC);

        sources.forEach(d => {
            const name = type === 'CLI' ? d[1] : d[9];
            if (!name) return;
            if (!stats[name]) stats[name] = { count: 0, vios: 0 };
            stats[name].count++;
            if (d[11] && d[11].toUpperCase() !== 'NIL') stats[name].vios++;
        });

        let sorted = Object.entries(stats).sort((a, b) => {
            if (type === 'LP') {
                const ratioA = a[1].vios / a[1].count;
                const ratioB = b[1].vios / b[1].count;
                return rank === 'BEST' ? ratioA - ratioB : ratioB - ratioA;
            }
            return rank === 'BEST' ? b[1].count - a[1].count : a[1].count - b[1].count;
        }).slice(0, 5);

        let html = `<table><thead><tr><th>RANK</th><th>${type} NAME</th><th>TOTAL ANALYSIS</th><th>VIOLATIONS</th></tr></thead><tbody>`;
        sorted.forEach((item, idx) => {
            html += `<tr><td>${idx+1}</td><td><b>${item[0]}</b></td><td>${item[1].count}</td><td>${item[1].vios}</td></tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }
</script>
</body>
</html>
