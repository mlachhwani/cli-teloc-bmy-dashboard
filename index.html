<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECR RAIPUR | PERFORMANCE DASHBOARD</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f8fafc; --header-bg: #0f172a; --accent-blue: #3b82f6; --danger: #ef4444; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: #1e293b; overflow-x: hidden; }
        header { background: var(--header-bg); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; color: white; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .main-title { font-weight: 800; font-size: 1.4rem; background: linear-gradient(to right, #60a5fa, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .container { max-width: 1600px; margin: 25px auto; padding: 0 20px; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .card { background: white; border-radius: 20px; padding: 20px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.3s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent-blue); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .card .count { font-size: 2.8rem; font-weight: 800; color: var(--header-bg); line-height: 1; margin: 10px 0; }
        .graph-container { height: 160px; width: 100%; cursor: pointer; position: relative; }
        .search-row { display: flex; gap: 12px; margin-bottom: 30px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .search-row input { flex: 1; padding: 12px 20px; border-radius: 10px; border: 2px solid #e2e8f0; font-weight: 600; font-size: 1rem; outline: none; }
        .performer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 30px; }
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); }
        .modal-content { background: white; width: 95%; max-height: 92vh; border-radius: 24px; padding: 30px; overflow-y: auto; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border-radius: 12px; overflow: hidden; }
        th { background: #1e293b; color: white; padding: 15px; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; font-weight: 600; text-align: center; }
        .btn-act { padding: 12px 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; color: white; transition: 0.2s; }
        .btn-act:hover { opacity: 0.9; transform: scale(0.97); }
        .zero-audit { color: var(--danger); font-weight: 800; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <img src="ir_logo.png" style="height:50px;">
        <div><span class="main-title">SECR RAIPUR</span><br><small style="color:#94a3b8; font-weight:600;">ELECTRICAL (OP) DASHBOARD</small></div>
    </div>
    <div style="display:flex; gap:12px; align-items:center;">
        <select id="monthSelector" onchange="loadNewMonth()" style="padding:10px; border-radius:10px; font-weight:700;">
            <option value="2026-01">January 2026</option>
            <option value="2025-12">December 2025</option>
        </select>
        <input type="date" id="globalDate" onchange="refreshDashboard()" style="padding:9px; border-radius:10px; border:1px solid #cbd5e1;">
        <button onclick="resetToMonthly()" class="btn-act" style="background:var(--accent-blue)">FULL MONTH</button>
    </div>
</header>

<div class="container">
    <div class="search-row">
        <input type="text" id="globalSearch" placeholder="üîç Enter Loco, LP Name or CLI Name and hit Search...">
        <button onclick="executeSearch()" class="btn-act" style="background:#0f172a; min-width:160px;">SEARCH</button>
    </div>
    
    <div class="summary-grid" id="mainGrid"></div>

    <div class="performer-grid">
        <button class="btn-act" style="background:#0f172a;" onclick="openMerit('CLI', 'BEST')">ü•á TOP CLIs</button>
        <button class="btn-act" style="background:#0f172a;" onclick="openMerit('LP', 'BEST')">üèÜ TOP LPs</button>
        <button class="btn-act" style="background:var(--danger);" onclick="openMerit('CLI', 'WORST')">‚ö†Ô∏è TALEENDERS</button>
        <button class="btn-act" style="background:var(--danger);" onclick="openMerit('LP', 'WORST')">üî¥ LP ATTENTION</button>
    </div>
</div>

<div class="modal" id="dataModal">
    <div class="modal-content">
        <span onclick="closeModal()" style="float:right; cursor:pointer; font-size:2.5rem; color:#64748b;">&times;</span>
        <h2 id="modalTitle" style="color:#0f172a; font-weight:800; margin:0;">Analysis View</h2>
        <div id="dlGroup" style="margin:20px 0; display:none; gap:12px;">
            <button class="btn-act" style="background:#be123c;" onclick="exportPDF()">PDF</button>
            <button class="btn-act" style="background:#15803d;" onclick="exportExcel()">EXCEL</button>
        </div>
        <div id="modalChartContainer" style="height:350px; width:100%; display:none; margin-bottom:20px;">
            <canvas id="zoomedChart"></canvas>
        </div>
        <div id="tableContainer"></div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    const ROOT = "https://raw.githubusercontent.com/mlachhwani/cli-teloc-bmy-dashboard/main";
    let database = { SPM: [], CVVRS: [], TELOC: [], BULK: [], BULK_VIO: [], MASTER_CLI: [] };
    let activeCharts = {};

    async function loadNewMonth() {
        const selMonth = document.getElementById('monthSelector').value;
        const now = new Date();
        if (selMonth === now.toISOString().slice(0, 7)) {
            document.getElementById('globalDate').value = now.toISOString().split('T')[0];
        } else {
            const [y, m] = selMonth.split('-').map(Number);
            document.getElementById('globalDate').value = `${selMonth}-${new Date(y, m, 0).getDate()}`;
        }

        const path = `${ROOT}/data/${selMonth}`;
        await Promise.all([
            fetchCSV(`${path}/spm.csv`, 'SPM'), fetchCSV(`${path}/cvvrs.csv`, 'CVVRS'),
            fetchCSV(`${path}/teloc_daily.csv`, 'TELOC'), fetchCSV(`${path}/bulk_analysis.csv`, 'BULK'),
            fetchCSV(`${path}/bulk_violation_details.csv`, 'BULK_VIO'),
            fetchCSV(`${ROOT}/cli_master.csv`, 'MASTER_CLI')
        ]);
        initCards(); refreshDashboard();
    }

    async function fetchCSV(f, k) {
        try {
            const res = await fetch(f);
            const text = await res.text();
            database[k] = text.split('\n').filter(l => l.trim() !== "").slice(1).map(row => {
                const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || row.split(',');
                return cols.map(v => v.trim().replace(/"/g, ''));
            });
        } catch (e) { database[k] = []; }
    }

    function initCards() {
        const cats = [
            {id:'SPM',t:'SPM / RTIS AUDITS', db:'SPM'}, {id:'CV',t:'CVVRS ANALYSIS', db:'CVVRS'}, 
            {id:'TL',t:'TELOC CELL AUDITS', db:'TELOC'}, {id:'BK',t:'BULK AUTO ANALYSIS', db:'BULK'}
        ];
        document.getElementById('mainGrid').innerHTML = cats.map(c => `
            <div class="card">
                <h3 style="font-size:0.75rem; color:#64748b; font-weight:800; margin:0;">${c.t}</h3>
                <span class="count" id="count${c.id}">0</span>
                <div class="graph-container" onclick="zoomGraph('${c.id}')">
                    <canvas id="chart${c.id}"></canvas>
                </div>
                <div style="display:flex; gap:8px; margin-top:15px;">
                    <button class="btn-act" style="background:#1e293b; flex:1; padding:8px; font-size:0.7rem;" onclick="openDataWindow('${c.id}', false)">LIST</button>
                    <button class="btn-act" style="background:var(--danger); flex:1; padding:8px; font-size:0.7rem;" onclick="openDataWindow('${c.id}', true)">VIOS</button>
                </div>
            </div>`).join('');
    }

    function createChart(id, data, isBulk, isZoomed = false) {
        const ctx = document.getElementById(id).getContext('2d');
        if (activeCharts[id]) activeCharts[id].destroy();

        const dates = [...new Set(data.map(d => d[isBulk ? 0 : 2]))].sort();
        const totals = dates.map(d => isBulk ? (parseInt(data.find(r => r[0] === d)?.[1]) || 0) : data.filter(r => r[2] === d).length);
        const vios = dates.map(d => isBulk ? (parseInt(data.find(r => r[0] === d)?.[2]) || 0) : data.filter(r => r[2] === d && r[11] && r[11].toUpperCase() !== 'NIL').length);

        activeCharts[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates.map(d => d.split('-')[2]),
                datasets: [
                    { label: 'Violations', data: vios, backgroundColor: '#ef4444', borderRadius: 5 },
                    { label: 'Total Audits', data: totals, backgroundColor: '#e2e8f0', borderRadius: 5 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    datalabels: { anchor: 'end', align: 'top', font: { weight: '800', size: isZoomed ? 11 : 8 }, display: (c) => c.dataset.label === 'Total Audits' && c.dataset.data[c.dataIndex] > 0 }
                },
                scales: { 
                    y: { display: isZoomed, beginAtZero: true }, 
                    x: { grid: { display: false }, ticks: { font: { weight: '700', size: isZoomed ? 12 : 9 } } }
                }
            }
        });
    }

    function zoomGraph(cat) {
        document.getElementById('dataModal').style.display = 'flex';
        document.getElementById('modalTitle').innerText = `Growth Analysis: ${cat}`;
        document.getElementById('modalChartContainer').style.display = 'block';
        document.getElementById('tableContainer').innerHTML = "";
        document.getElementById('dlGroup').style.display = 'none';
        
        const dbKey = cat === 'CV' ? 'CVVRS' : cat === 'TL' ? 'TELOC' : (cat === 'BK' ? 'BULK' : 'SPM');
        setTimeout(() => createChart('zoomedChart', database[dbKey], cat === 'BK', true), 300);
    }

    function refreshDashboard() {
        ['SPM', 'CV', 'TL'].forEach(k => {
            const dbKey = k === 'CV' ? 'CVVRS' : k === 'TL' ? 'TELOC' : 'SPM';
            const d = document.getElementById('globalDate').value;
            document.getElementById(`count${k}`).innerText = d ? database[dbKey].filter(x => x[2] === d).length : database[dbKey].length;
            createChart(`chart${k}`, database[dbKey], false);
        });
        const bD = document.getElementById('globalDate').value;
        const bTot = bD ? (database.BULK.find(x => x[0] === bD)?.[1] || 0) : database.BULK.reduce((s, r) => s + (parseInt(r[1]) || 0), 0);
        document.getElementById('countBK').innerText = bTot;
        createChart('chartBK', database.BULK, true);
    }

    function closeModal() { 
        document.getElementById('dataModal').style.display = 'none'; 
        document.getElementById('modalChartContainer').style.display = 'none';
        if(activeCharts['zoomedChart']) activeCharts['zoomedChart'].destroy();
    }

    // Previous Search, Merit, Window functions remain robustly integrated
    function executeSearch() {
        const term = document.getElementById('globalSearch').value.toUpperCase();
        if(!term) return;
        const res = [];
        ['SPM', 'CVVRS', 'TELOC', 'BULK_VIO'].forEach(k => {
            database[k].forEach(r => {
                if(r.join('|').toUpperCase().includes(term)) {
                    if(k === 'BULK_VIO') res.push([r[0], 'AUTO-BULK', r[1], r[12], r[11], r[7], 'BULK']);
                    else res.push([r[2], r[1], r[7], r[6], r[9], r[11], k]);
                }
            });
        });
        currentHeaders = ["DATE", "CLI NAME", "LOCO", "TRAIN", "LP NAME", "VIOLATION", "SOURCE"];
        currentFilteredData = res;
        document.getElementById('modalChartContainer').style.display = 'none';
        showTable(`Records for: ${term}`);
    }

    function openMerit(type, rank) {
        const stats = {};
        if(type === 'CLI' && database.MASTER_CLI.length > 0) {
            database.MASTER_CLI.forEach(m => { if(m[0]) stats[m[0].trim()] = { count: 0, vios: 0 }; });
        }
        [...database.SPM, ...database.CVVRS, ...database.TELOC].forEach(d => {
            const name = (type === 'CLI' ? d[1] : d[9])?.trim();
            if(!name || name === '-' || name.toUpperCase().includes("TELOC CELL")) return;
            if(!stats[name]) stats[name] = { count: 0, vios: 0 };
            stats[name].count++; if(d[11] && d[11].toUpperCase() !== 'NIL') stats[name].vios++;
        });
        let sorted = Object.entries(stats).sort((a,b) => {
            if(rank === 'WORST') return a[1].count - b[1].count || b[1].vios - a[1].vios;
            return b[1].count - a[1].count || a[1].vios - b[1].vios;
        }).slice(0, 15);
        currentHeaders = ["RANK", "NAME", "AUDITS", "VIOLATIONS"];
        currentFilteredData = sorted.map((item, i) => [`#${i+1}`, item[1].count === 0 ? `<span class="zero-audit">${item[0]} (PENDING)</span>` : item[0], item[1].count, item[1].vios]);
        document.getElementById('modalChartContainer').style.display = 'none';
        showTable(`${rank} ${type} Performance`);
    }

    function showTable(title) {
        document.getElementById('dataModal').style.display = 'flex';
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('dlGroup').style.display = 'flex';
        document.getElementById('tableContainer').innerHTML = `<table><thead><tr>${currentHeaders.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${currentFilteredData.map(r=>`<tr>${r.map(c=>`<td>${c||'-'}</td>`).join('')}</tr>`).join('')}</tbody></table>`;
    }

    function openDataWindow(cat, onlyVios) {
        document.getElementById('modalChartContainer').style.display = 'none';
        const dbKey = cat === 'BK' ? 'BULK_VIO' : (cat === 'CV' ? 'CVVRS' : cat === 'TL' ? 'TELOC' : 'SPM');
        const selDate = document.getElementById('globalDate').value;
        let filtered = database[dbKey];
        if (selDate) filtered = filtered.filter(d => d[0] === selDate || d[2] === selDate);
        if (dbKey === 'BULK_VIO') {
            currentHeaders = ["DATE", "LOCO", "STATION", "SPEED", "ASPECT", "LP NAME", "TRAIN", "ALP NAME"];
            currentFilteredData = filtered.map(r => [r[0], r[1], r[2], r[5], r[7], r[11], r[12], r[15]]);
        } else {
            if (onlyVios) filtered = filtered.filter(d => d[11] && d[11].toUpperCase() !== 'NIL');
            currentHeaders = ["CLI", "ANALYSIS DT", "WORK DT", "TRAIN", "LOCO", "LP NAME", "ALP NAME", "VIOLATION"];
            currentFilteredData = filtered.map(r => [r[1], r[2], r[3], r[6], r[7], r[9], r[10], r[11]]);
        }
        showTable(`${cat} Report`);
    }

    function resetToMonthly() { document.getElementById('globalDate').value = ""; refreshDashboard(); }
    function exportExcel() { const ws = XLSX.utils.aoa_to_sheet([currentHeaders, ...currentFilteredData]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Report"); XLSX.writeFile(wb, "SECR_Report.xlsx"); }
    function exportPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); doc.autoTable({ head: [currentHeaders], body: currentFilteredData.map(r => r.map(c => String(c).replace(/<[^>]*>/g, ''))), theme: 'grid' }); doc.save("SECR_Report.pdf"); }

    window.onload = loadNewMonth;
</script>
</body>
</html>
