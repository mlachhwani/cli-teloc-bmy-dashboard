<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECR RAIPUR | MASTER DASHBOARD v12.4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f8fafc; --header-bg: #0f172a; --accent: #3b82f6; --danger: #ef4444; --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); margin: 0; color: #1e293b; }
        header { background: var(--header-bg); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; color: white; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .main-title { font-weight: 800; font-size: 1.5rem; background: linear-gradient(to right, #60a5fa, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .container { max-width: 1600px; margin: 30px auto; padding: 0 20px; }
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .card { background: white; border-radius: 24px; padding: 22px; border: 1px solid #e2e8f0; box-shadow: var(--card-shadow); transition: 0.3s; cursor: pointer; }
        .card:hover { transform: translateY(-8px); border-color: var(--accent); }
        .count { font-size: 3rem; font-weight: 800; color: var(--header-bg); margin: 5px 0; display: block; }
        .graph-box { height: 170px; margin: 15px 0; background: #fff; border-radius: 12px; }
        .performer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 40px; }
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); }
        .modal-content { background: white; width: 96%; max-height: 92vh; border-radius: 24px; padding: 30px; overflow: hidden; display: flex; flex-direction: column; }
        .table-wrapper { overflow: auto; flex-grow: 1; border: 1px solid #e2e8f0; border-radius: 12px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background: #1e293b; color: white; padding: 14px; font-size: 0.75rem; position: sticky; top: 0; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; text-align: center; font-weight: 600; }
        .btn-act { padding: 12px 18px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; color: white; transition: 0.3s; }
        #zoomGraphArea { height: 350px; width: 100%; margin-bottom: 20px; display: none; }
    </style>
</head>
<body>

<header>
    <div style="display:flex; align-items:center; gap:15px;">
        <img src="ir_logo.png" style="height:55px;">
        <div><span class="main-title">SECR RAIPUR</span><br><small style="color:#94a3b8; font-weight:700;">ELECTRICAL (OP) PERFORMANCE</small></div>
    </div>
    <div style="display:flex; gap:12px; align-items:center;">
        <select id="monthSelector" onchange="loadData()" style="padding:10px; border-radius:12px; font-weight:700;">
            <option value="2025-12">December 2025</option>
            <option value="2026-01" selected>January 2026</option>
        </select>
        <input type="date" id="globalDate" onchange="updateUI()" style="padding:10px; border-radius:12px; font-weight:700;">
        <button onclick="resetView()" class="btn-act" style="background:var(--accent)">ALL DATA</button>
    </div>
</header>

<div class="container">
    <div class="summary-grid" id="mainGrid"></div>
    <div class="performer-grid">
        <button class="btn-act" style="background:#0f172a;" onclick="openMerit('CLI', 'BEST')">ü•á TOP 10 CLIs</button>
        <button class="btn-act" style="background:#0f172a;" onclick="openMerit('LP', 'BEST')">üèÜ TOP 10 LPs</button>
        <button class="btn-act" style="background:#64748b;" onclick="openMerit('CLI', 'WORST')">üìã CLI STATUS</button>
        <button class="btn-act" style="background:var(--danger);" onclick="openMerit('LP', 'WORST')">üîç LP MONITORING</button>
    </div>
</div>

<div class="modal" id="dataModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="modalTitle" style="margin:0; font-weight:800; color:#0f172a;">Performance View</h2>
            <div style="display:flex; gap:12px;">
                <button class="btn-act" style="background:#15803d;" onclick="exportExcel()">EXCEL</button>
                <button class="btn-act" style="background:#be123c;" onclick="exportPDF()">PDF</button>
                <span onclick="closeModal()" style="cursor:pointer; font-size:3rem; color:#64748b;">&times;</span>
            </div>
        </div>
        <div id="zoomGraphArea"><canvas id="zoomedChart"></canvas></div>
        <div class="table-wrapper" id="tableWrapper"></div>
    </div>
</div>

<script>
    const ROOT = "https://raw.githubusercontent.com/mlachhwani/cli-teloc-bmy-dashboard/main";
    let db = { SPM:{h:[], d:[]}, CVVRS:{h:[], d:[]}, TELOC:{h:[], d:[]}, BULK_SUM:{h:[], d:[]}, BULK_DET:{h:[], d:[]}, MASTER_CLI:[] };
    let charts = {};
    let currentData = [], currentHeaders = [];

    async function loadData() {
        const m = document.getElementById('monthSelector').value;
        const path = `${ROOT}/data/${m}`;
        await Promise.all([
            fetchCSV(`${path}/spm.csv`, 'SPM'), fetchCSV(`${path}/cvvrs.csv`, 'CVVRS'),
            fetchCSV(`${path}/teloc_daily.csv`, 'TELOC'), fetchCSV(`${path}/bulk_analysis.csv`, 'BULK_SUM'),
            fetchCSV(`${path}/bulk_violation_details.csv`, 'BULK_DET'),
            fetchCSV(`${ROOT}/cli_master.csv`, 'MASTER_CLI')
        ]);
        renderCards(); updateUI();
    }

    async function fetchCSV(url, key) {
        try {
            const r = await fetch(url);
            const t = await r.text();
            const rows = t.split('\n').filter(l => l.trim() !== "").map(row => {
                return (row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || []).map(v => v.trim().replace(/"/g, ''));
            });
            if(key === 'MASTER_CLI') db.MASTER_CLI = rows.slice(1);
            else { db[key].h = rows[0]; db[key].d = rows.slice(1); }
        } catch(e) { console.warn("Missing:", key); }
    }

    function renderCards() {
        const cats = [{id:'SPM', t:'SPM AUDITS'}, {id:'CVVRS', t:'CVVRS ANALYSIS'}, {id:'TELOC', t:'TELOC CELL'}, {id:'BULK', t:'BULK AUTO'}];
        document.getElementById('mainGrid').innerHTML = cats.map(c => `
            <div class="card" onclick="zoomGraph('${c.id}')">
                <small style="font-weight:800; color:#64748b;">${c.t}</small>
                <span class="count" id="count_${c.id}">0</span>
                <div class="graph-box"><canvas id="chart_${c.id}"></canvas></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-act" style="background:#1e293b; flex:1; font-size:0.75rem;" onclick="event.stopPropagation(); showTable('${c.id}', false)">LIST</button>
                    <button class="btn-act" style="background:var(--danger); flex:1; font-size:0.75rem;" onclick="event.stopPropagation(); showTable('${c.id}', true)">VIOS</button>
                </div>
            </div>`).join('');
    }

    function updateUI() {
        const dt = document.getElementById('globalDate').value;
        ['SPM','CVVRS','TELOC'].forEach(k => {
            const data = dt ? db[k].d.filter(r => r[2] === dt) : db[k].d;
            document.getElementById(`count_${k}`).innerText = data.length;
            draw(`chart_${k}`, db[k].d, false);
        });
        const bD = dt ? db.BULK_SUM.d.find(r => r[0] === dt) : null;
        document.getElementById('count_BULK').innerText = dt ? (bD ? bD[1] : 0) : db.BULK_SUM.d.reduce((a,b)=>a+parseInt(b[1]||0), 0);
        draw(`chart_BULK`, db.BULK_SUM.d, true);
    }

    function draw(canvasId, data, isBulk, isZoomed = false) {
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if(charts[canvasId]) charts[canvasId].destroy();

        const labels = Array.from({length: 31}, (_, i) => (i + 1).toString().padStart(2, '0'));
        
        // HAR GRAPH KA APNA DATA TOTALS
        const currentGraphTotals = labels.map(l => {
            const dayData = data.filter(r => {
                const dateVal = r[isBulk ? 0 : 2] || '';
                const parts = dateVal.split(/[-/.]/);
                const dayPart = parts[2]; 
                return dayPart && dayPart.padStart(2,'0') === l;
            });
            return isBulk ? dayData.reduce((a,b)=>a+parseInt(b[1]||0), 0) : dayData.length;
        });

        // HAR GRAPH KA APNA UNIQUE AVERAGE
        const sum = currentGraphTotals.reduce((a, b) => a + b, 0);
        const avg = sum / labels.length;

        charts[canvasId] = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels, 
                datasets: [
                    { 
                        data: currentGraphTotals, 
                        backgroundColor: '#3b82f6', 
                        borderRadius: 4,
                        order: 2
                    },
                    {
                        label: 'Avg',
                        data: Array(31).fill(avg),
                        borderColor: '#ef4444',
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        type: 'line',
                        pointRadius: 0,
                        fill: false,
                        order: 1
                    }
                ] 
            },
            options: { 
                responsive:true, maintainAspectRatio:false, 
                plugins:{ legend:{display:false} },
                scales:{ 
                    y:{display:isZoomed, beginAtZero:true}, 
                    x:{grid:{display:false}, ticks:{font:{size:8}}}
                }
            }
        });
    }

    function zoomGraph(id) {
        document.getElementById('dataModal').style.display = 'flex';
        document.getElementById('zoomGraphArea').style.display = 'block';
        document.getElementById('tableWrapper').style.display = 'none';
        const titles = { 'SPM': 'SPM AUDIT TIMELINE', 'CVVRS': 'CVVRS ANALYSIS TIMELINE', 'TELOC': 'TELOC CELL TIMELINE', 'BULK': 'BULK VIOLATION TIMELINE' };
        document.getElementById('modalTitle').innerText = titles[id] || "Graph View";
        const key = id === 'BULK' ? 'BULK_SUM' : id;
        setTimeout(() => draw('zoomedChart', db[key].d, id === 'BULK', true), 200);
    }

    function showTable(id, onlyVios) {
        document.getElementById('zoomGraphArea').style.display = 'none';
        document.getElementById('tableWrapper').style.display = 'block';
        const dt = document.getElementById('globalDate').value;
        const key = id === 'BULK' ? 'BULK_DET' : id;
        document.getElementById('modalTitle').innerText = (onlyVios ? "VIOLATION LIST: " : "DATA LIST: ") + id;
        currentHeaders = db[key].h;
        let data = db[key].d;
        if(dt) data = data.filter(r => (r[id==='BULK'?0:2]||'').includes(dt));
        if(onlyVios) data = data.filter(r => id==='BULK' ? r.some(c => String(c).toUpperCase()==='YES') : (r[11] && r[11].toUpperCase()!=='NIL'));
        currentData = data;
        renderTable();
    }

    function openMerit(type, rank) {
        document.getElementById('zoomGraphArea').style.display = 'none';
        document.getElementById('tableWrapper').style.display = 'block';
        document.getElementById('modalTitle').innerText = (type === 'LP') ? 'LP Safety Performance Merit List' : 'CLI Audit Performance Merit List';
        const stats = {};
        if(type === 'CLI') db.MASTER_CLI.forEach(m => { if(m[0]) stats[m[0].trim()] = { count: 0, vios: 0 }; });
        [...db.SPM.d, ...db.CVVRS.d, ...db.TELOC.d].forEach(r => {
            const name = (type === 'CLI' ? r[1] : r[9])?.trim();
            if(!name || name === '-' || name.toUpperCase().includes("TELOC")) return;
            if(!stats[name]) stats[name] = { count: 0, vios: 0 };
            stats[name].count++; if(r[11] && r[11].toUpperCase() !== 'NIL') stats[name].vios++;
        });
        let sorted = Object.entries(stats);
        if(type === 'CLI') {
            sorted.sort((a,b) => rank === 'BEST' ? (b[1].count - a[1].count || b[1].vios - a[1].vios) : (a[1].count - b[1].count));
        } else {
            sorted.sort((a,b) => {
                const sA = (a[1].count * 10) - (a[1].vios * 25);
                const sB = (b[1].count * 10) - (b[1].vios * 25);
                return rank === 'BEST' ? (sB - sA) : (sA - sB);
            });
        }
        currentHeaders = ["RANK", "NAME", "TOTAL JANCH", "VIOLATIONS", "PERF SCORE"];
        currentData = sorted.slice(0, 15).map((x, i) => [`#${i+1}`, x[0], x[1].count, x[1].vios, (type==='CLI'?(x[1].count+x[1].vios):((x[1].count*10)-(x[1].vios*25)))]);
        renderTable();
    }

    function renderTable() {
        let html = `<table><thead><tr>${currentHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
        html += currentData.map(r => `<tr>${r.map(c => `<td>${c||'-'}</td>`).join('')}</tr>`).join('');
        document.getElementById('tableWrapper').innerHTML = html + `</tbody></table>`;
        document.getElementById('dataModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('dataModal').style.display = 'none'; }
    function resetView() { document.getElementById('globalDate').value = ""; updateUI(); }
    function exportExcel() { const ws = XLSX.utils.aoa_to_sheet([currentHeaders, ...currentData]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "Report.xlsx"); }
    function exportPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a3'); doc.autoTable({ head:[currentHeaders], body:currentData }); doc.save("Report.pdf"); }
    window.onload = loadData;
</script>
</body>
</html>
