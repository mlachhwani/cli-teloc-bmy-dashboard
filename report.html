<!DOCTYPE html>
<html>
<head>
  <title>SECR REPORT VIEW</title>
  <style>
    body { font-family: sans-serif; background: #f8fafc; padding: 20px; }
    .head-bar { background: #003399; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; position: sticky; top: 0; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    th { background: #f1f5f9; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-size: 0.8rem; position: sticky; top: 60px; }
    td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
    #filter { padding: 8px; width: 250px; border-radius: 4px; border: none; }
  </style>
</head>
<body>
  <div class="head-bar">
    <h2 id="title" style="margin:0">Loading...</h2>
    <input type="text" id="filter" placeholder="Filter this table..." onkeyup="doFieldFilter()">
    <button onclick="window.close()" style="padding:8px 15px; cursor:pointer;">CLOSE</button>
  </div>
  <div id="content"></div>

  <script>
    const API = "https://script.google.com/macros/s/AKfycbzLXnwvfTPtajZ9WEalkhAcwawGHNQ9EtG3Yo3H6T0zmlopr9nmywm3uPVnKcf_91UHZQ/exec";
    const p = new URLSearchParams(window.location.search);

    async function init() {
      const search = p.get('search');
      const url = `${API}?action=fullTable&type=${p.get('type')}&date=${p.get('date')}&onlyViolations=${p.get('onlyViolations')}`;
      const res = await fetch(url);
      let data = await res.json();

      if(search) {
        let header = data[0];
        data = [header, ...data.slice(1).filter(r => r.join(' ').toLowerCase().includes(search.toLowerCase()))];
      }

      let h = '<table><thead><tr>';
      data[0].forEach(c => h += `<th>${c}</th>`);
      h += '</tr></thead><tbody id="tb">';
      data.slice(1).forEach(r => {
        h += '<tr>';
        r.forEach(c => h += `<td>${c}</td>`);
        h += '</tr>';
      });
      document.getElementById('content').innerHTML = h + '</tbody></table>';
      document.getElementById('title').innerText = `${p.get('type')} Report`;
    }

    function doFieldFilter() {
      let val = document.getElementById('filter').value.toLowerCase();
      let rows = document.querySelectorAll('#tb tr');
      rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? '' : 'none');
    }
    window.onload = init;
  </script>
</body>
</html>
